{% assign type = 'product-bundles' %}
{% assign bundle = shop.metaobjects[type][block.settings.shortcode] %}
{% assign price = 0 %}

{% if bundle %}
  <div class="bundle" data-bundle-id="{{ bundle.id }}">
    <p class="bundle-title">{{ bundle.bundle_title }}</p>
    <p class="bundle-description">{{ bundle.description }}</p>
    <p class="discounted-price">{{ bundle.discount }}% {{ 'discount' | t }}</p>

    <div class="products">
      {% for product in bundle.products.value %}
        <div class="product">
          <a href="{{ product.url }}">
            <img
              class="product-image"
              src="{{ product.featured_image | image_url: width: 200, height: 200 }}"
              alt="{{ product.featured_image.alt }}"
              loading="lazy"
              height="200"
              width="200"
            >
          </a>
          <a class="product-name" href="{{ product.url }}">
            <p>{{ product.title }}</p>
          </a>
          <p class="product-price">{{ product.price | money }}</p>
          {% assign price = price | plus: product.price %}
        </div>
      {% endfor %}
    </div>

    {% assign discountedPrice = price
      | divided_by: 100
      | times: bundle.discount
    %}
    {% assign savings = price | minus: discountedPrice | minus: price | abs %}

    <div class="add-to-cart-button">
      <p class="discounted-price">
        <span class="original-price">{{ price | money }}</span>
        {{ price | minus: discountedPrice | money }}
        {{ 'only' | t }}
      </p>
      <p class="savings-badge">{{ 'save' | t }} {{ savings | money }}</p>

      <form action="/cart/add" method="post" class="bundle-form">
        {% for product in bundle.products.value %}
          <input
            type="hidden"
            name="items[{{ forloop.index0 }}][id]"
            value="{{ product.variants.first.id }}"
          >
          <input
            type="hidden"
            name="items[{{ forloop.index0 }}][quantity]"
            value="1"
          >
          <input
            type="hidden"
            name="items[{{ forloop.index0 }}][properties][_bundle_id]"
            value="{{ bundle.bundle_name.value }}"
          >
          <input
            type="hidden"
            name="items[{{ forloop.index0 }}][properties][_bundle_discount]"
            value="{{ bundle.discount }}%"
          >
        {% endfor %}
        <button type="submit" class="bundle-add-to-cart-btn">{{ 'action' | t }}</button>
      </form>
    </div>
  </div>
{% endif %}

{% schema %}
{
  "name": "Product Bundle",
  "target": "section",
  "stylesheet": "style.css",
  "javascript": "bundle.js",
  "templates": ["index", "product", "collection", "cart"],
  "settings": [
    {
      "type": "text",
      "id": "shortcode",
      "label": "t:label",
      "info": "t:info"
    },
    {
      "type": "checkbox",
      "id": "auto_inject",
      "label": "Auto-inject on product pages",
      "info": "Automatically show bundle when customer views a bundled product",
      "default": false
    }
  ]
}
{% endschema %}
