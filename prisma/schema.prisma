// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model active_stores {
  shop        String    @id
  isActive    Boolean?  @default(false)
  setupError  String?
  lastError   String?
  lastErrorAt DateTime?
}

model session {
  id      String  @id
  content String? //MySQL requires adding @db.Text
  shop    String?

  @@index([shop])
}

model oauth_state {
  state     String   @id
  shop      String
  isOnline  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([shop])
  @@index([createdAt])
}

// Automatic bundle generation data (DEPRECATED - use auto_bundle_rules)
model auto_bundle_data {
  shop        String   @id
  collections String[] //MySQL requires adding @db.Text
  tags        String[]
  minPrice    String
  maxPrice    String
  minProducts String
  discount    String
}

// New: Multiple auto bundle rules support
model auto_bundle_rules {
  id          String   @id @default(cuid())
  shop        String
  name        String   // Rule name for identification
  collections String[] // Selected collection names
  tags        String[] // Selected product tags
  minPrice    String
  maxPrice    String
  minProducts String
  discount    String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([shop])
}

// Discount id for the bundle
model bundle_discount_id {
  bundleId   String @id
  bundleName String
  discountId String
  shop       String
}

// AI-generated FBT bundles
model ai_fbt_bundles {
  id                    String   @id @default(cuid())
  shop                  String
  productId             String
  bundledProductIds     String[]
  confidenceScore       Float
  support               Float
  lift                  Float
  generatedAt           DateTime @default(now())
  isActive              Boolean  @default(true)
  source                String   @default("AI")
  variantGroupId        String?
  bundleMetaobjectId    String?
  discountId            String?
  isManualOverride      Boolean  @default(false)
  lastUpdatedAt         DateTime @default(now())

  @@index([shop, productId])
  @@index([shop, isActive])
}

// Event tracking for AI bundles
model ai_bundle_events {
  id             String   @id @default(cuid())
  shop           String
  bundleId       String
  productId      String
  eventType      String
  variantGroupId String?
  sessionId      String?
  customerId     String?
  createdAt      DateTime @default(now())
  metadata       Json?

  @@index([shop, bundleId])
  @@index([shop, eventType])
  @@index([createdAt])
}

// A/B test variant assignments
model ai_bundle_ab_assignments {
  id             String   @id @default(cuid())
  shop           String
  sessionId      String
  productId      String
  variantGroupId String
  assignedAt     DateTime @default(now())
  expiresAt      DateTime

  @@index([sessionId, productId])
  @@index([expiresAt])
}

// AI FBT configuration per shop
model ai_fbt_config {
  shop                  String   @id
  isEnabled             Boolean  @default(false)
  minSupport            Float    @default(0.01)
  minConfidence         Float    @default(0.3)
  minLift               Float    @default(1.0)
  maxBundlesPerProduct  Int      @default(3)
  lookbackDays          Int      @default(90)
  lastGeneratedAt       DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @default(now())
}

// ============================================
// V2 BUNDLE SYSTEM (Sprint 1+)
// ============================================

// Core bundle entity
model Bundle {
  id                    String              @id @default(cuid())
  shop                  String

  // Basic Info
  name                  String
  title                 String
  description           String?
  slug                  String

  // Bundle Type (Sprint 1: FIXED only)
  type                  BundleType          @default(FIXED)
  status                BundleStatus        @default(DRAFT)

  // Shopify References
  shopifyProductId      String?
  shopifyMetaobjectId   String?

  // Display Settings
  displayOrder          Int                 @default(0)
  featuredImage         String?
  images                String[]

  // Currency (prepared for multi-currency, Sprint 9+)
  currencyCode          String              @default("USD")

  // Metadata
  tags                  String[]
  metadata              Json?

  // Timestamps
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  publishedAt           DateTime?

  // Relations
  components            BundleComponent[]
  pricingRules          BundlePricingRule[]
  discounts             BundleDiscount[]
  inventoryRecord       BundleInventory?
  analytics             BundleAnalytics[]
  events                BundleEvent[]

  @@unique([shop, slug])
  @@index([shop, status])
  @@index([shop, type])
  @@index([createdAt])
}

enum BundleType {
  FIXED              // All products included, no choices (Sprint 1)
  MIX_MATCH          // Customer selects from options (Sprint 5)
  TIERED             // Volume-based pricing tiers (Sprint 4)
  BOGO               // Buy one get one (Sprint 3)
  BUILD_YOUR_OWN     // Customer builds custom bundle (Sprint 6)
  SUBSCRIPTION       // Recurring bundle (Sprint 7)
  GIFT               // Gift bundle with message (Sprint 8)
}

enum BundleStatus {
  DRAFT
  ACTIVE
  SCHEDULED
  PAUSED
  ARCHIVED
}

// Products included in a bundle
model BundleComponent {
  id                    String              @id @default(cuid())
  bundleId              String
  bundle                Bundle              @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  // Product Reference
  shopifyProductId      String
  shopifyVariantId      String?

  // Component Settings
  quantity              Int                 @default(1)
  isRequired            Boolean             @default(true)
  displayOrder          Int                 @default(0)

  // For Mix & Match (Sprint 5+)
  groupId               String?
  minQuantity           Int                 @default(0)
  maxQuantity           Int                 @default(1)

  // Pricing Override
  priceAdjustment       Decimal?            @db.Decimal(10, 2)
  priceAdjustmentType   PriceAdjustmentType @default(NONE)

  // Cached Product Data (for performance)
  cachedTitle           String?
  cachedPrice           Decimal?            @db.Decimal(10, 2)
  cachedCompareAtPrice  Decimal?            @db.Decimal(10, 2)
  cachedImageUrl        String?
  cachedSku             String?
  cachedInventory       Int?
  lastSyncedAt          DateTime?

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@index([bundleId])
  @@index([shopifyProductId])
  @@index([groupId])
}

enum PriceAdjustmentType {
  NONE
  FIXED_AMOUNT
  PERCENTAGE
  FIXED_PRICE
}

// Pricing rules for bundles
model BundlePricingRule {
  id                    String              @id @default(cuid())
  bundleId              String
  bundle                Bundle              @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  name                  String
  priority              Int                 @default(0)
  isActive              Boolean             @default(true)

  // Rule Type
  ruleType              PricingRuleType     @default(BUNDLE_DISCOUNT)

  // Conditions (JSON for flexibility)
  conditions            Json                @default("{}")

  // Discount Settings
  discountType          DiscountType        @default(PERCENTAGE)
  discountValue         Decimal             @db.Decimal(10, 2)

  // Limits
  usageLimit            Int?
  usageCount            Int                 @default(0)
  startsAt              DateTime?
  endsAt                DateTime?

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@index([bundleId, isActive])
  @@index([priority])
}

enum PricingRuleType {
  BUNDLE_DISCOUNT       // Standard bundle discount (Sprint 1)
  VOLUME_TIER           // Buy more, save more (Sprint 4)
  BOGO                  // Buy X get Y (Sprint 3)
  MEMBER_PRICE          // Customer tag based (Sprint 6)
  TIME_LIMITED          // Flash sale (Sprint 6)
  FIRST_PURCHASE        // New customer discount (Sprint 6)
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FIXED_PRICE
  FREE_ITEM
}

// Shopify discount references
model BundleDiscount {
  id                    String              @id @default(cuid())
  bundleId              String
  bundle                Bundle              @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  shopifyDiscountId     String
  discountCode          String?
  discountType          String              @default("automatic")

  isActive              Boolean             @default(true)

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@unique([bundleId, shopifyDiscountId])
  @@index([shopifyDiscountId])
}

// Inventory tracking
model BundleInventory {
  id                    String              @id @default(cuid())
  bundleId              String              @unique
  bundle                Bundle              @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  // Inventory Method
  trackingMethod        InventoryMethod     @default(COMPONENT_BASED)

  // Bundle-specific inventory (if applicable)
  bundleQuantity        Int?
  lowStockThreshold     Int                 @default(10)

  // Calculated from components
  availableQuantity     Int                 @default(0)
  reservedQuantity      Int                 @default(0)

  // Settings
  allowOversell         Boolean             @default(false)
  autoSyncEnabled       Boolean             @default(true)

  lastCalculatedAt      DateTime            @default(now())

  @@index([bundleId])
}

enum InventoryMethod {
  COMPONENT_BASED       // Min of all component inventories
  BUNDLE_SPECIFIC       // Bundle has its own inventory
  UNLIMITED             // No inventory tracking
}

// Daily analytics aggregation
model BundleAnalytics {
  id                    String              @id @default(cuid())
  bundleId              String
  bundle                Bundle              @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  date                  DateTime            @db.Date

  // Engagement Metrics
  impressions           Int                 @default(0)
  clicks                Int                 @default(0)
  addToCarts            Int                 @default(0)

  // Conversion Metrics
  orders                Int                 @default(0)
  unitsSold             Int                 @default(0)

  // Revenue Metrics
  revenue               Decimal             @default(0) @db.Decimal(12, 2)
  discountAmount        Decimal             @default(0) @db.Decimal(12, 2)
  averageOrderValue     Decimal             @default(0) @db.Decimal(10, 2)

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@unique([bundleId, date])
  @@index([date])
}

// Individual event tracking
model BundleEvent {
  id                    String              @id @default(cuid())
  shop                  String
  bundleId              String
  bundle                Bundle              @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  eventType             String

  // Context
  sessionId             String?
  customerId            String?
  orderId               String?

  // Event Data
  quantity              Int                 @default(1)
  revenue               Decimal?            @db.Decimal(10, 2)
  metadata              Json?

  // Source
  source                String?
  deviceType            String?

  createdAt             DateTime            @default(now())

  @@index([shop, bundleId])
  @@index([eventType])
  @@index([createdAt])
}

// Inventory sync log for debugging
model InventorySyncLog {
  id                    String              @id @default(cuid())
  shop                  String
  bundleId              String

  syncType              String
  previousQuantity      Int
  newQuantity           Int
  triggerProductId      String?

  success               Boolean
  errorMessage          String?

  createdAt             DateTime            @default(now())

  @@index([shop, bundleId])
  @@index([createdAt])
}
